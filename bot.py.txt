import discord
import random
import json
import os
from discord.ext import commands
from datetime import datetime
import calendar

intents = discord.Intents.default()
bot = commands.Bot(command_prefix="!", intents=intents)

# ãƒ•ã‚¡ã‚¤ãƒ«å
COIN_FILE = "user_coins.json"
CHARM_FILE = "charms.json"
SUPER_CHARM_FILE = "super_charms.json"
SUPER_CHARM_ACTIVE_FILE = "super_charm_active.json"
BANK_FILE = "bank.json"
LAST_INTEREST_WEEK_FILE = "last_interest_week.json"
DAILY_FILE = "daily_bonus.json"
RANK_FILE = "rank_bonus.json"

# åˆæœŸè¨­å®š
STARTING_COINS = 100
SLOTS = ["ğŸ’", "ğŸ‹", "ğŸŠ", "ğŸ‡", "ğŸ‰", "â­", "ğŸ””"]
DAILY_BONUSES = {0: 100, 1: 150, 2: 200, 3: 250, 4: 300, 5: 400, 6: 700}
RANK_BONUSES = [1000, 700, 500, 300, 200]

# JSONèª­ã¿æ›¸ã
def load_json(filename):
    if os.path.exists(filename):
        with open(filename, "r") as f:
            return json.load(f)
    return {}

def save_json(filename, data):
    with open(filename, "w") as f:
        json.dump(data, f)

# ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
user_coins = load_json(COIN_FILE)
user_charms = load_json(CHARM_FILE)
user_super_charms = load_json(SUPER_CHARM_FILE)
user_super_charm_active = load_json(SUPER_CHARM_ACTIVE_FILE)
user_bank = load_json(BANK_FILE)
last_interest_week = load_json(LAST_INTEREST_WEEK_FILE)
daily_claims = load_json(DAILY_FILE)
rank_claims = load_json(RANK_FILE)

# é€±ç•ªå·å–å¾—
def get_current_week():
    return datetime.utcnow().isocalendar().week

# éŠ€è¡Œåˆ©å­ã®è‡ªå‹•åŠ ç®—ï¼ˆé€±1å›ï¼‰
def apply_weekly_interest():
    current_week = get_current_week()
    if last_interest_week.get("week") == current_week:
        return
    for user_id, balance in user_bank.items():
        if balance > 0:
            interest = max(1, int(balance * 0.01))
            user_bank[user_id] += interest
    last_interest_week["week"] = current_week
    save_json(BANK_FILE, user_bank)
    save_json(LAST_INTEREST_WEEK_FILE, last_interest_week)

@bot.event
async def on_ready():
    print(f"ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ: {bot.user}")
    try:
        synced = await bot.tree.sync()
        print(f"ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã‚’åŒæœŸã—ã¾ã—ãŸ: {len(synced)}å€‹")
    except Exception as e:
        print(f"åŒæœŸã‚¨ãƒ©ãƒ¼: {e}")
# ğŸ° ã‚¹ãƒ­ãƒƒãƒˆã‚³ãƒãƒ³ãƒ‰
@bot.tree.command(name="slot", description="ã‚¹ãƒ­ãƒƒãƒˆãƒã‚·ãƒ³ã‚’å›ã—ã¦ã‚³ã‚¤ãƒ³ã‚’è³­ã‘ã‚ˆã†ï¼")
async def slot(interaction: discord.Interaction, bet: int):
    user_id = str(interaction.user.id)
    apply_weekly_interest()

    if user_id not in user_coins:
        user_coins[user_id] = STARTING_COINS

    if bet <= 0 or bet > user_coins[user_id]:
        await interaction.response.send_message("âš ï¸ è³­ã‘é‡‘ãŒç„¡åŠ¹ã‹ã€ã‚³ã‚¤ãƒ³ãŒè¶³ã‚Šãªã„ã‚ˆï¼", ephemeral=True)
        return

    # ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ©ãƒƒã‚­ãƒ¼ãƒãƒ£ãƒ¼ãƒ ä½¿ç”¨ä¸­
    if user_super_charm_active.get(user_id, False):
        roll = [random.choice(SLOTS)] * 3
        winnings = bet * 3
        user_coins[user_id] += winnings
        user_super_charm_active[user_id] = False
        save_json(SUPER_CHARM_ACTIVE_FILE, user_super_charm_active)
        await interaction.response.send_message(f"{' | '.join(roll)}")
        await interaction.followup.send(f"ğŸŒŸ ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ©ãƒƒã‚­ãƒ¼ãƒãƒ£ãƒ¼ãƒ ç™ºå‹•ï¼ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆï¼{winnings}ã‚³ã‚¤ãƒ³ç²å¾—ï¼")
        save_json(COIN_FILE, user_coins)
        return

    # ãƒ©ãƒƒã‚­ãƒ¼ãƒãƒ£ãƒ¼ãƒ ä½¿ç”¨
    has_charm = user_charms.get(user_id, False)
    if has_charm:
        roll = random.choices(
            population=[
                ["ğŸ’", "ğŸ’", "ğŸ’"],
                ["ğŸ‹", "ğŸ‹", "ğŸŠ"],
                ["ğŸ‡", "ğŸ‡", "ğŸ‰"],
                ["ğŸŠ", "ğŸŠ", "ğŸ‹"],
                [random.choice(SLOTS), random.choice(SLOTS), random.choice(SLOTS)]
            ],
            weights=[10, 25, 25, 25, 15],
            k=1
        )[0]
        user_charms[user_id] = False
        save_json(CHARM_FILE, user_charms)
    else:
        roll = [random.choice(SLOTS) for _ in range(3)]

    await interaction.response.send_message(f"{' | '.join(roll)}")

    if roll[0] == roll[1] == roll[2]:
        winnings = bet * 5
        user_coins[user_id] += winnings
        await interaction.followup.send(f"ğŸ‰ ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆï¼{winnings}ã‚³ã‚¤ãƒ³ç²å¾—ï¼")
    elif roll[0] == roll[1] or roll[1] == roll[2] or roll[0] == roll[2]:
        winnings = bet * 2
        user_coins[user_id] += winnings
        await interaction.followup.send(f"âœ¨ ãƒŠã‚¤ã‚¹ï¼{winnings}ã‚³ã‚¤ãƒ³ç²å¾—ï¼")
    else:
        user_coins[user_id] -= bet
        await interaction.followup.send(f"ğŸ˜¢ ã¯ãšã‚Œï¼{bet}ã‚³ã‚¤ãƒ³å¤±ã£ãŸã‚ˆâ€¦")

    save_json(COIN_FILE, user_coins)
    await interaction.followup.send(f"ğŸ’° ç¾åœ¨ã®ã‚³ã‚¤ãƒ³æ®‹é«˜: {user_coins[user_id]}")

# ğŸ§§ ãƒ©ãƒƒã‚­ãƒ¼ãƒãƒ£ãƒ¼ãƒ è³¼å…¥
@bot.tree.command(name="buycharm", description="ãƒ©ãƒƒã‚­ãƒ¼ãƒãƒ£ãƒ¼ãƒ ã‚’è³¼å…¥ã™ã‚‹ã‚ˆ")
async def buycharm(interaction: discord.Interaction):
    user_id = str(interaction.user.id)
    if user_charms.get(user_id, False):
        await interaction.response.send_message("ğŸ§§ ã™ã§ã«ãŠå®ˆã‚Šã‚’æŒã£ã¦ã‚‹ã‚ˆï¼", ephemeral=True)
        return
    if user_coins.get(user_id, STARTING_COINS) < 300:
        await interaction.response.send_message("ğŸ’¸ ã‚³ã‚¤ãƒ³ãŒè¶³ã‚Šãªã„ã‚ˆï¼", ephemeral=True)
        return
    user_coins[user_id] -= 300
    user_charms[user_id] = True
    save_json(COIN_FILE, user_coins)
    save_json(CHARM_FILE, user_charms)
    await interaction.response.send_message("ğŸ§§ ãƒ©ãƒƒã‚­ãƒ¼ãƒãƒ£ãƒ¼ãƒ ã‚’è³¼å…¥ã—ãŸã‚ˆï¼")

# ğŸŒŸ ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ©ãƒƒã‚­ãƒ¼ãƒãƒ£ãƒ¼ãƒ ä½¿ç”¨
@bot.tree.command(name="usesupercharm", description="ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ©ãƒƒã‚­ãƒ¼ãƒãƒ£ãƒ¼ãƒ ã‚’ä½¿ã†ã‚ˆ")
async def usesupercharm(interaction: discord.Interaction):
    user_id = str(interaction.user.id)
    if not user_super_charms.get(user_id, False):
        await interaction.response.send_message("ğŸ§§ ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ©ãƒƒã‚­ãƒ¼ãƒãƒ£ãƒ¼ãƒ ã‚’æŒã£ã¦ãªã„ã‚ˆï¼", ephemeral=True)
        return
    if user_super_charm_active.get(user_id, False):
        await interaction.response.send_message("âš ï¸ ã™ã§ã«ä½¿ç”¨ä¸­ã ã‚ˆï¼", ephemeral=True)
        return
    user_super_charms[user_id] = False
    user_super_charm_active[user_id] = True
    save_json(SUPER_CHARM_FILE, user_super_charms)
    save_json(SUPER_CHARM_ACTIVE_FILE, user_super_charm_active)
    await interaction.response.send_message("ğŸŒŸ ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ©ãƒƒã‚­ãƒ¼ãƒãƒ£ãƒ¼ãƒ ã‚’ä½¿ã£ãŸã‚ˆï¼æ¬¡ã®ã‚¹ãƒ­ãƒƒãƒˆã§ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆç¢ºå®šï¼")

# ğŸ ãƒŸã‚¹ãƒ†ãƒªãƒ¼ãƒœãƒƒã‚¯ã‚¹è³¼å…¥
@bot.tree.command(name="buybox", description="ãƒŸã‚¹ãƒ†ãƒªãƒ¼ãƒœãƒƒã‚¯ã‚¹ã‚’è³¼å…¥ã—ã¦é–‹ã‘ã‚‹ã‚ˆï¼")
async def buybox(interaction: discord.Interaction):
    user_id = str(interaction.user.id)
    if user_coins.get(user_id, STARTING_COINS) < 400:
        await interaction.response.send_message("ğŸ’¸ ã‚³ã‚¤ãƒ³ãŒè¶³ã‚Šãªã„ã‚ˆï¼", ephemeral=True)
        return
    user_coins[user_id] -= 400
    result = random.randint(-500, 1000)
    got_super_charm = random.random() < 0.05
    msg = ""
    if got_super_charm and not user_super_charms.get(user_id, False):
        user_super_charms[user_id] = True
        save_json(SUPER_CHARM_FILE, user_super_charms)
        msg += "ğŸŒŸ ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ©ãƒƒã‚­ãƒ¼ãƒãƒ£ãƒ¼ãƒ ã‚’å¼•ãå½“ã¦ãŸï¼\n"
    elif got_super_charm:
        result += 300
        msg += "ğŸ ãƒ¬ã‚¢ãŠå®ˆã‚ŠãŒå‡ºãŸã‘ã©ã€ã™ã§ã«æŒã£ã¦ãŸã‹ã‚‰ä»£ã‚ã‚Šã«+300ã‚³ã‚¤ãƒ³ï¼\n"
    user_coins[user_id] += result
    save_json(COIN_FILE, user_coins)
    if result > 0:
        msg += f"ğŸ‰ +{result}ã‚³ã‚¤ãƒ³ã‚²ãƒƒãƒˆï¼"
    elif result < 0:
        msg += f"ğŸ˜± {result}ã‚³ã‚¤ãƒ³å¤±ã£ãŸâ€¦"
    else:
        msg += "ğŸ˜ ä¸­èº«ã¯ç©ºã£ã½ã ã£ãŸï¼Â±0ã‚³ã‚¤ãƒ³ï¼"
    msg += f"\nğŸ’° ç¾åœ¨ã®ã‚³ã‚¤ãƒ³æ®‹é«˜: {user_coins[user_id]}"
    await interaction.response.send_message(msg)
# ğŸ“… ãƒ‡ã‚¤ãƒªãƒ¼ãƒœãƒ¼ãƒŠã‚¹
@bot.tree.command(name="daily", description="ä»Šæ—¥ã®ãƒ‡ã‚¤ãƒªãƒ¼ãƒœãƒ¼ãƒŠã‚¹ã‚’å—ã‘å–ã‚‹ã‚ˆï¼")
async def daily(interaction: discord.Interaction):
    user_id = str(interaction.user.id)
    weekday = datetime.utcnow().weekday()  # æœˆæ›œ=0, æ—¥æ›œ=6
    current_week = get_current_week()

    if user_id not in daily_claims:
        daily_claims[user_id] = {"week": current_week, "claimed": []}

    if daily_claims[user_id]["week"] != current_week:
        daily_claims[user_id] = {"week": current_week, "claimed": []}

    if weekday in daily_claims[user_id]["claimed"]:
        await interaction.response.send_message("ğŸ“… ä»Šæ—¥ã®ãƒœãƒ¼ãƒŠã‚¹ã¯ã‚‚ã†å—ã‘å–ã£ãŸã‚ˆï¼ã¾ãŸæ˜æ—¥ã­ï¼", ephemeral=True)
        return

    bonus = DAILY_BONUSES[weekday]
    user_coins[user_id] = user_coins.get(user_id, STARTING_COINS) + bonus
    daily_claims[user_id]["claimed"].append(weekday)

    save_json(COIN_FILE, user_coins)
    save_json(DAILY_FILE, daily_claims)

    day_name = calendar.day_name[weekday]
    await interaction.response.send_message(
        f"ğŸ {day_name}ã®ãƒ‡ã‚¤ãƒªãƒ¼ãƒœãƒ¼ãƒŠã‚¹ï¼{bonus}ã‚³ã‚¤ãƒ³ã‚’ã‚²ãƒƒãƒˆã—ãŸã‚ˆï¼\nğŸ’° ç¾åœ¨ã®ã‚³ã‚¤ãƒ³æ®‹é«˜: {user_coins[user_id]}"
    )

# ğŸ¦ éŠ€è¡Œï¼šé ã‘å…¥ã‚Œ
@bot.tree.command(name="deposit", description="éŠ€è¡Œã«ã‚³ã‚¤ãƒ³ã‚’é ã‘ã‚‹ã‚ˆ")
async def deposit(interaction: discord.Interaction, amount: int):
    apply_weekly_interest()
    user_id = str(interaction.user.id)
    if amount <= 0 or user_coins.get(user_id, STARTING_COINS) < amount:
        await interaction.response.send_message("âš ï¸ é‡‘é¡ãŒç„¡åŠ¹ã‹ã€ã‚³ã‚¤ãƒ³ãŒè¶³ã‚Šãªã„ã‚ˆï¼", ephemeral=True)
        return
    user_coins[user_id] -= amount
    user_bank[user_id] = user_bank.get(user_id, 0) + amount
    save_json(COIN_FILE, user_coins)
    save_json(BANK_FILE, user_bank)
    await interaction.response.send_message(f"ğŸ¦ {amount}ã‚³ã‚¤ãƒ³ã‚’éŠ€è¡Œã«é ã‘ãŸã‚ˆï¼")

# ğŸ¦ éŠ€è¡Œï¼šå¼•ãå‡ºã—
@bot.tree.command(name="withdraw", description="éŠ€è¡Œã‹ã‚‰ã‚³ã‚¤ãƒ³ã‚’å¼•ãå‡ºã™ã‚ˆ")
async def withdraw(interaction: discord.Interaction, amount: int):
    apply_weekly_interest()
    user_id = str(interaction.user.id)
    if amount <= 0 or user_bank.get(user_id, 0) < amount:
        await interaction.response.send_message("âš ï¸ é‡‘é¡ãŒç„¡åŠ¹ã‹ã€é é‡‘ãŒè¶³ã‚Šãªã„ã‚ˆï¼", ephemeral=True)
        return
    user_bank[user_id] -= amount
    user_coins[user_id] = user_coins.get(user_id, STARTING_COINS) + amount
    save_json(COIN_FILE, user_coins)
    save_json(BANK_FILE, user_bank)
    await interaction.response.send_message(f"ğŸ’¸ {amount}ã‚³ã‚¤ãƒ³ã‚’éŠ€è¡Œã‹ã‚‰å¼•ãå‡ºã—ãŸã‚ˆï¼")

# ğŸ¦ éŠ€è¡Œï¼šæ®‹é«˜ç¢ºèª
@bot.tree.command(name="bank", description="éŠ€è¡Œã®é é‡‘æ®‹é«˜ã‚’ç¢ºèªã™ã‚‹ã‚ˆ")
async def bank(interaction: discord.Interaction):
    apply_weekly_interest()
    user_id = str(interaction.user.id)
    balance = user_bank.get(user_id, 0)
    await interaction.response.send_message(f"ğŸ¦ ã‚ãªãŸã®éŠ€è¡Œé é‡‘æ®‹é«˜ã¯ **{balance}ã‚³ã‚¤ãƒ³** ã ã‚ˆï¼")

# ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒœãƒ¼ãƒŠã‚¹å—ã‘å–ã‚Š
@bot.tree.command(name="rankbonus", description="2é€±ã«1å›ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒœãƒ¼ãƒŠã‚¹ã‚’å—ã‘å–ã‚‹ã‚ˆï¼")
async def rankbonus(interaction: discord.Interaction):
    user_id = str(interaction.user.id)
    current_week = get_current_week()
    weekday = datetime.utcnow().weekday()

    if current_week % 2 != 0 or weekday != 0:
        await interaction.response.send_message("ğŸ“… ã“ã®ãƒœãƒ¼ãƒŠã‚¹ã¯**å¶æ•°é€±ã®æœˆæ›œæ—¥**ã ã‘å—ã‘å–ã‚Œã‚‹ã‚ˆï¼", ephemeral=True)
        return

    if rank_claims.get(user_id) == current_week:
        await interaction.response.send_message("ğŸ ä»Šé€±ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒœãƒ¼ãƒŠã‚¹ã¯ã‚‚ã†å—ã‘å–ã£ãŸã‚ˆï¼", ephemeral=True)
        return

    sorted_users = sorted(user_coins.items(), key=lambda x: x[1], reverse=True)
    top_users = [uid for uid, _ in sorted_users[:len(RANK_BONUSES)]]

    if user_id in top_users:
        rank = top_users.index(user_id)
        bonus = RANK_BONUSES[rank]
        user_coins[user_id] += bonus
        rank_claims[user_id] = current_week
        save_json(COIN_FILE, user_coins)
        save_json(RANK_FILE, rank_claims)
        await interaction.response.send_message(
            f"ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°{rank+1}ä½ï¼{bonus}ã‚³ã‚¤ãƒ³ã®ãƒœãƒ¼ãƒŠã‚¹ã‚’ã‚²ãƒƒãƒˆï¼\nğŸ’° ç¾åœ¨ã®ã‚³ã‚¤ãƒ³æ®‹é«˜: {user_coins[user_id]}"
        )
    else:
        await interaction.response.send_message("ğŸ˜¢ ä»Šå›ã¯ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«å…¥ã‚Œãªã‹ã£ãŸã¿ãŸã„â€¦ã¾ãŸæ¬¡å›ãŒã‚“ã°ã‚ã†ï¼", ephemeral=True)

# ğŸ’° æ®‹é«˜ç¢ºèª
@bot.tree.command(name="balance", description="è‡ªåˆ†ã®ã‚³ã‚¤ãƒ³æ®‹é«˜ã‚’ç¢ºèªã™ã‚‹ã‚ˆ")
async def balance(interaction: discord.Interaction):
    user_id = str(interaction.user.id)
    coins = user_coins.get(user_id, STARTING_COINS)
    await interaction.response.send_message(f"ğŸ’° ã‚ãªãŸã®ã‚³ã‚¤ãƒ³æ®‹é«˜ã¯ {coins} ã‚³ã‚¤ãƒ³ã ã‚ˆï¼")
import os

TOKEN = os.getenv("YOUR_BOT_TOKEN")
bot.run(TOKEN)
